<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form-Associated Number Input Component Test</title>

    <script>
        const optStyles =  /*css*/` <style>
        [part="container"] {
            display: flex;
            align-items: center;
            gap: 0;
        }

        [part="group"] {
            display: flex;
        }

        [part="input"] {
            width: 30px;
            height: 40px;
            font-size: 24px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 0;
            -moz-appearance: textfield;
            margin-left: -1px; /* Overlap borders slightly */
        }

        [part="input"]::-webkit-outer-spin-button,
        [part="input"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        [part="input"]:first-child {
            border-top-left-radius: 6px;
            border-bottom-left-radius: 6px;
            margin-left: 0; /* Reset margin for the first input */
        }

        [part="input"]:last-child {
            border-top-right-radius: 6px;
            border-bottom-right-radius: 6px;
        }

        [part="separator"] {
            margin: 0 10px;
            font-size: 20px;
            color: #ccc;
        }


        [part="input"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px #007BFF; /* Custom focus ring */
            z-index: 1; /* Prevent overlapping issues */
        }

        [part="input"].invalid {
            border-color: red;
        }

        [part="error-message"] {
            color: red;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }

        [part="error-message"].visible {
            display: block;
        }
    </style>`;
        class NumberInput extends HTMLElement {
            static formAssociated = true;

            static get observedAttributes() {
                return ['required', 'group-size', 'groups'];
            }

            #internals;
            #groupSize;
            #groups;
            #shadow;
            #isSubmitted; // Initialize submission flag

            constructor() {
                super();
                this.#internals = this.attachInternals();
                this.#shadow = this.attachShadow({ mode: 'open' });
                this.#isSubmitted = false; // Initialize submission flag
            }

            connectedCallback() {
                this.#groupSize = parseInt(this.getAttribute('group-size')) || 3;
                this.#groups = parseInt(this.getAttribute('groups')) || 2;
                this.#render();

                this.#addEventListeners();

                if (this.hasAttribute('required')) {
                    this.#internals.setValidity({ valueMissing: true }, 'Number is required');
                }

                // Listen for form submission to set the submission flag
                if (this.form) {
                    this.form.addEventListener('submit', this.#onFormSubmit.bind(this));
                    this.form.addEventListener('reset', this.#onFormReset.bind(this));
                }
            }

            disconnectedCallback() {
                this.#removeEventListeners();
            }

            attributeChangedCallback(name, oldValue, newValue) {
                if (name === 'required') {
                    const isRequired = this.hasAttribute('required');
                    if (isRequired && !this.value) {
                        this.#internals.setValidity({ valueMissing: true }, 'Number is required');
                    } else {
                        this.#internals.setValidity({});
                    }
                } else if (name === 'group-size' || name === 'groups') {
                    this.#groupSize = parseInt(this.getAttribute('group-size')) || 3;
                    this.#groups = parseInt(this.getAttribute('groups')) || 2;
                    this.#render();
                    this.#addEventListeners();
                }
            }

            get inputs() {
                return this.#shadow.querySelectorAll('[part="input"]');
            }

            get value() {
                return Array.from(this.inputs)
                    .map(input => input.value)
                    .join('');
            }

            set value(val) {
                if (typeof val === 'string') {
                    const digits = val.replace(/\D/g, '').slice(0, this.#groupSize * this.#groups);
                    const inputs = this.inputs;
                    digits.split('').forEach((digit, i) => {
                        if (inputs[i]) {
                            inputs[i].value = digit;
                        }
                    });
                    this.#updateValue();
                }
            }

            get form() {
                return this.#internals.form;
            }

            get name() {
                return this.getAttribute('name');
            }

            checkValidity() {
                return this.#internals.checkValidity();
            }

            reportValidity() {
                return this.#internals.reportValidity();
            }


            #render() {
                let groupsHtml = '';
                for (let i = 0; i < this.#groups; i++) {
                    groupsHtml += `
                        <div part="group">
                            ${this.#createInputBoxes(this.#groupSize)}
                        </div>
                        ${i < this.#groups - 1 ? '<div part="separator">-</div>' : ''}
                    `;
                }

                this.#shadow.innerHTML = `
                    ${optStyles}
                    <div part="container">
                        ${groupsHtml}
                    </div>
                    <div part="error-message"></div> <!-- Error message element -->
                `;
            }

            #addEventListeners() {
                this.inputs.forEach((input, index) => {
                    input.addEventListener('beforeinput', (event) => this.#onBeforeInput(event));
                    input.addEventListener('input', (event) => this.#onInput(event, index));
                    input.addEventListener('keydown', (event) => this.#onKeyDown(event, index));
                    input.addEventListener('paste', (event) => this.#onPaste(event, index));
                });
            }

            #removeEventListeners() {
                this.inputs.forEach((input, index) => {
                    input.removeEventListener('beforeinput', (event) => this.#onBeforeInput(event));
                    input.removeEventListener('input', (event) => this.#onInput(event, index));
                    input.removeEventListener('keydown', (event) => this.#onKeyDown(event, index));
                    input.removeEventListener('paste', (event) => this.#onPaste(event, index));
                });
            }

            #createInputBoxes(count) {
                let inputs = '';
                for (let i = 0; i < count; i++) {
                    inputs += `<input type="number" part="input" maxlength="1" inputmode="numeric" pattern="[0-9]*" />`;
                }
                return inputs;
            }

            #onBeforeInput(event) {
                if (!/^\d$/.test(event.data)) {
                    event.preventDefault();
                }
            }

            #onInput(event, index) {
                const input = event.target;
                const value = input.value.replace(/\D/g, ''); // Remove non-numeric characters

                if (/^\d$/.test(value)) {
                    input.value = value; // Ensure only single digit
                    const nextInput = this.inputs[index + 1];
                    if (nextInput) {
                        nextInput.focus();
                    }
                } else if (value === '') {
                    // Do nothing for empty input
                } else {
                    input.value = ''; // Reset invalid input
                }

                this.#updateValue();
            }

            #onKeyDown(event, index) {
                const input = event.target;
                const stopEvent = () => {
                    event.preventDefault();
                    event.stopImmediatePropagation();
                };
                if (event.key === 'Backspace') {
                    stopEvent();
                    if (input.value === '') {
                        const previousInput = this.inputs[index - 1];
                        if (previousInput) {
                            previousInput.value = '';
                            previousInput.focus();
                        }
                    } else {
                        input.value = '';
                        this.#updateValue();
                    }
                } else if (event.key === 'ArrowLeft') {
                    const previousInput = this.inputs[index - 1];
                    if (previousInput) {
                        stopEvent();
                        previousInput.focus();
                    }
                } else if (event.key === 'ArrowRight') {
                    const nextInput = this.inputs[index + 1];
                    if (nextInput) {
                        stopEvent();
                        nextInput.focus();
                    }
                } else if (event.key === 'Enter') {
                    if (this.form) {
                        this.form.requestSubmit(); // Submit the form programmatically
                    }
                } else if (event.key === 'ArrowUp') {
                    stopEvent();
                    input.value = (+(input.value) + 1) % 10;
                    this.#updateValue();
                } else if (event.key === 'ArrowDown') {
                    stopEvent();
                    input.value = (+(input.value) - 1 + 10) % 10;
                    this.#updateValue();
                }
            }

            #onPaste(event, index) {
                event.preventDefault();
                const paste = (event.clipboardData || window.clipboardData).getData('text');
                const digits = paste.replace(/\D/g, '').slice(0, this.#groupSize * this.#groups);
                const inputs = this.inputs;
                digits.split('').forEach((digit, i) => {
                    if (inputs[index + i]) {
                        inputs[index + i].value = digit;
                    }
                });
                this.#updateValue();
                const nextInput = this.inputs[index + digits.length];
                if (nextInput) {
                    nextInput.focus();
                }
            }

            #onFormSubmit(event) {
                this.#isSubmitted = true;
                this.#updateValue();
            }

            #onFormReset(event) {
                this.#isSubmitted = false;
                this.#updateValue();
                for (const input of this.inputs) {
                    input.value = '';
                }
            }

            #updateValue() {
                const otpValue = Array.from(this.inputs)
                    .map(input => input.value)
                    .join('');

                this.#internals.setFormValue(otpValue); // Update form value

                let isValid = true;
                let errorMessage = '';

                if (this.hasAttribute('required')) {
                    if (otpValue.length < this.#groupSize * this.#groups) {
                        isValid = false;
                        errorMessage = this.getAttribute('data-missingvalue') || 'Number is incomplete';
                        this.#internals.setValidity({ valueMissing: true }, errorMessage);
                    } else {
                        this.#internals.setValidity({});
                    }
                }

                if (!isValid && this.#isSubmitted) { // Show error only if form is submitted
                    this.#shadow.querySelector('[part="error-message"]').textContent = errorMessage;
                    this.#shadow.querySelector('[part="error-message"]').classList.add('visible');
                } else {
                    this.#shadow.querySelector('[part="error-message"]').textContent = '';
                    this.#shadow.querySelector('[part="error-message"]').classList.remove('visible');
                }

                this.dispatchEvent(new Event('input', { bubbles: true, composed: true })); // Dispatch input event
            }

        }

        customElements.define('number-input', NumberInput);
    </script>
</head>

<body>
    <form novalidate id="otp-form" action="#" method="POST">
        <div>
            <label for="otp">Enter Number:</label>
            <number-input required id="otp" name="otp" group-size="3" groups="2"></number-input>
        </div>
        <div style="margin-top: 20px;">
            <button type="submit">Submit Number</button>
            <button type="reset">Reset Number</button>
        </div>
    </form>

    <script>
        document.getElementById('otp-form').addEventListener('submit', function (event) {
            if (!event.target.checkValidity()) {
                console.log('Form is invalid');
                event.preventDefault();
                return;
            }
            event.preventDefault();
            const otpValue = event.target.elements['otp'].value;
            alert(`Submitted Number: ${otpValue}`);
        });
    </script>
</body>

</html>